local module = {}

module.TailWagging = function(rig)
    local tailBones = {}
    local RigTorso = rig.Torso
    local RigTailAttach = RigTorso.Attach
    local RigTail = RigTorso.Tail

    -- Find all tail bones and store initial CFrames
    for _, v in pairs(RigTail:GetDescendants()) do
        if v:IsA("Bone") then
            table.insert(tailBones, v)
            v:SetAttribute("CFrame", v.CFrame)
        end
    end

    if #tailBones == 0 then
        warn("No tail bones found!")
        return
    end

    -- Sort bones based on hierarchy
    table.sort(tailBones, function(a, b)
        return a.Name < b.Name
    end)

    local runService = game:GetService("RunService")

    -- Configurable settings
    local settings = {
        wagSpeed = 3,  -- Speed of wagging
        wagAmplitude = 15,  -- Maximum wag angle
        bounceSpeed = 4,  -- Speed of bouncing
        bounceAmplitude = 5,  -- Maximum bounce angle
        rotationInfluence = 5,  -- Influence of character rotation
        inertiaFactor = 0.5,  -- How much the tail follows movement
        avoidGround = true,  -- Prevents clipping into ground
        symmetricalTails = true,  -- Ensures both tails move identically
        mirrorTails = true,  -- Option to mirror tail movements
        randomizeMotion = false  -- Option to add randomness to wagging
    }

    local timeElapsed = 0
    local lastRotation = RigTailAttach.Orientation.Y
    local lastPosition = RigTorso.Position

    runService.RenderStepped:Connect(function(deltaTime)
        timeElapsed = timeElapsed + deltaTime
        local currentRotation = RigTailAttach.Orientation.Y
        local rotationDelta = currentRotation - lastRotation
        lastRotation = currentRotation

        local positionDelta = RigTorso.Position - lastPosition
        lastPosition = RigTorso.Position

        for i, bone in ipairs(tailBones) do
            local boneOffset = i * 0.5
            local wagAngle = math.sin(timeElapsed * settings.wagSpeed + boneOffset) * settings.wagAmplitude
            local bounceAngle = math.sin(timeElapsed * settings.bounceSpeed + boneOffset) * settings.bounceAmplitude
            local rotationOffset = rotationDelta * settings.rotationInfluence / i
            local inertiaOffset = positionDelta.Magnitude * settings.inertiaFactor / i

            if settings.randomizeMotion then
                wagAngle = wagAngle * math.random(0.8, 1.2)
                bounceAngle = bounceAngle * math.random(0.8, 1.2)
            end

            if settings.mirrorTails and (i % 2 == 0) then
                wagAngle = -wagAngle
            end

            local newCFrame = bone:GetAttribute("CFrame")
                * CFrame.Angles(math.rad(bounceAngle + inertiaOffset), math.rad(wagAngle + rotationOffset), 0)

            if settings.avoidGround and RigTorso.Position.Y - newCFrame.Position.Y < 2 then
                newCFrame = newCFrame + Vector3.new(0, 0.1, 0)
            end

            bone.CFrame = newCFrame
        end
    end)
end

return module
